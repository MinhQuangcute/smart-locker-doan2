<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Locker Chung Cư - Đăng nhập / Đăng ký</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: 20px auto; }
    .tabs { display: flex; margin-bottom: 10px; }
    .tab { flex: 1; text-align: center; padding: 8px; border: 1px solid #ccc; cursor: pointer; }
    .tab.active { background: #007bff; color: white; }
    .panel { display: none; border: 1px solid #ccc; padding: 10px; }
    .panel.active { display: block; }
    label { display: block; margin-top: 6px; }
    input { width: 100%; padding: 6px; margin-top: 2px; box-sizing: border-box; }
    button { margin-top: 8px; padding: 6px 10px; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1><i class="fas fa-lock"></i> Smart Locker Chung Cư</h1>
  <p>Đăng ký & đăng nhập bằng số điện thoại + OTP</p>

  <div class="tabs">
    <div id="tabRegister" class="tab active">Đăng ký</div>
    <div id="tabLogin" class="tab">Đăng nhập</div>
  </div>

  <!-- PANEL ĐĂNG KÝ -->
  <div id="panelRegister" class="panel active">
    <h2>Đăng ký cư dân mới</h2>
    <label>Họ tên:</label>
    <input type="text" id="regFullName" placeholder="Nguyễn Văn A" />

    <label>Số điện thoại:</label>
    <input type="text" id="regPhone" placeholder="0989xxxxxx" />

    <label>Căn hộ (vd: A101):</label>
    <input type="text" id="regApartment" placeholder="A101" />

    <button id="regSendOtpBtn">1. Gửi OTP</button>

    <label>OTP:</label>
    <input type="text" id="regOtp" placeholder="6 số OTP" />
    <button id="regSubmitBtn">2. Xác nhận & Đăng ký</button>
  </div>

  <!-- PANEL ĐĂNG NHẬP -->
  <div id="panelLogin" class="panel">
    <h2>Đăng nhập</h2>

    <label>Số điện thoại:</label>
    <input type="text" id="loginPhone" placeholder="0989xxxxxx" />
    <button id="loginSendOtpBtn">1. Gửi OTP</button>

    <label>OTP:</label>
    <input type="text" id="loginOtp" placeholder="6 số OTP" />
    <button id="loginSubmitBtn">2. Xác nhận & Đăng nhập</button>
  </div>

  <p id="status"></p>

  <script>
    const tabRegister = document.getElementById("tabRegister");
    const tabLogin = document.getElementById("tabLogin");
    const panelRegister = document.getElementById("panelRegister");
    const panelLogin = document.getElementById("panelLogin");
    const statusEl = document.getElementById("status");

    let regVerificationId = null;
    let loginVerificationId = null;

    // Chuyển tab
    tabRegister.addEventListener("click", () => {
      tabRegister.classList.add("active");
      tabLogin.classList.remove("active");
      panelRegister.classList.add("active");
      panelLogin.classList.remove("active");
      statusEl.textContent = "";
    });

    tabLogin.addEventListener("click", () => {
      tabLogin.classList.add("active");
      tabRegister.classList.remove("active");
      panelLogin.classList.add("active");
      panelRegister.classList.remove("active");
      statusEl.textContent = "";
    });

    // Helper gọi API gửi OTP
    async function sendOtp(phoneInput) {
      const phoneNumber = phoneInput.value.trim();
      if (!phoneNumber) {
        statusEl.style.color = "red";
        statusEl.textContent = "Vui lòng nhập số điện thoại";
        return null;
      }
      statusEl.style.color = "black";
      statusEl.textContent = "Đang gửi OTP...";

      try {
        const res = await fetch("/api/auth/send-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phoneNumber })
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
          statusEl.style.color = "red";
          statusEl.textContent = data.error || "Gửi OTP thất bại";
          return null;
        }

        console.log("Dev OTP:", data.otpCode); // xem trong console để test
        statusEl.style.color = "green";
        statusEl.textContent = "Đã gửi OTP! (xem console server nếu test)";
        return data.verificationId;
      } catch (err) {
        console.error(err);
        statusEl.style.color = "red";
        statusEl.textContent = "Lỗi kết nối server khi gửi OTP";
        return null;
      }
    }

    // 1. Đăng ký – GỬI OTP
    document.getElementById("regSendOtpBtn").addEventListener("click", async () => {
      const phoneInput = document.getElementById("regPhone");
      regVerificationId = await sendOtp(phoneInput);
    });

    // 2. Đăng ký – XÁC NHẬN & TẠO USER
    document.getElementById("regSubmitBtn").addEventListener("click", async () => {
      const fullName = document.getElementById("regFullName").value.trim();
      const phoneNumber = document.getElementById("regPhone").value.trim();
      const apartment = document.getElementById("regApartment").value.trim();
      const otpCode = document.getElementById("regOtp").value.trim();

      if (!regVerificationId) {
        statusEl.style.color = "red";
        statusEl.textContent = "Bạn cần bấm 'Gửi OTP' trước";
        return;
      }
      if (!fullName || !phoneNumber || !otpCode) {
        statusEl.style.color = "red";
        statusEl.textContent = "Vui lòng nhập đầy đủ Họ tên, SĐT, OTP";
        return;
      }

      statusEl.style.color = "black";
      statusEl.textContent = "Đang xác nhận đăng ký...";

      try {
        const res = await fetch("/api/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            phoneNumber,
            fullName,
            apartment,
            verificationId: regVerificationId,
            otpCode
          })
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
          statusEl.style.color = "red";
          statusEl.textContent = data.error || "Đăng ký thất bại";
          return;
        }

        // Lưu token & thông tin user
        localStorage.setItem("token", data.token);
        localStorage.setItem("phoneNumber", data.user.phoneNumber);
        localStorage.setItem("role", data.user.role || "resident");

        statusEl.style.color = "green";
        statusEl.textContent = "Đăng ký thành công! Đang chuyển vào hệ thống...";

        window.location.href = "/dashboard.html";
      } catch (err) {
        console.error(err);
        statusEl.style.color = "red";
        statusEl.textContent = "Lỗi kết nối server khi đăng ký";
      }
    });

    // 3. Đăng nhập – GỬI OTP
    document.getElementById("loginSendOtpBtn").addEventListener("click", async () => {
      const phoneInput = document.getElementById("loginPhone");
      loginVerificationId = await sendOtp(phoneInput);
    });

    // 4. Đăng nhập – XÁC NHẬN OTP
    document.getElementById("loginSubmitBtn").addEventListener("click", async () => {
      const otpCode = document.getElementById("loginOtp").value.trim();

      if (!loginVerificationId) {
        statusEl.style.color = "red";
        statusEl.textContent = "Bạn cần bấm 'Gửi OTP' trước";
        return;
      }
      if (!otpCode) {
        statusEl.style.color = "red";
        statusEl.textContent = "Vui lòng nhập OTP";
        return;
      }

      statusEl.style.color = "black";
      statusEl.textContent = "Đang xác nhận đăng nhập...";

      try {
        const res = await fetch("/api/auth/verify-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            verificationId: loginVerificationId,
            otpCode
          })
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
          statusEl.style.color = "red";
          statusEl.textContent = data.error || "Đăng nhập thất bại";
          return;
        }

        // Lưu token & thông tin user
        localStorage.setItem("token", data.token);
        localStorage.setItem("phoneNumber", data.phoneNumber);
        localStorage.setItem("role", data.role || "resident");

        statusEl.style.color = "green";
        statusEl.textContent = "Đăng nhập thành công! Đang chuyển vào hệ thống...";

        window.location.href = "/dashboard.html";
      } catch (err) {
        console.error(err);
        statusEl.style.color = "red";
        statusEl.textContent = "Lỗi kết nối server khi đăng nhập";
      }
    });
  </script>
</body>
</html>
