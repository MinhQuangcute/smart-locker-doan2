<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üîê Smart Locker - B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Font gi·ªëng c√°c trang kh√°c -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --wood-bg-1: #fff7d9;
      --wood-bg-2: #f6cf7c;
      --wood-accent: #f4a226;
      --wood-accent-dark: #c97a12;
      --wood-text: #4b3b2a;
      --error: #dc2626;
      --success: #16a34a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top left, var(--wood-bg-1), var(--wood-bg-2));
      color: var(--wood-text);
    }

    .admin-shell {
      width: 100%;
      max-width: 1100px;
      padding: 16px;
    }

    .admin-card {
      background: rgba(255, 255, 255, 0.96);
      border-radius: 22px;
      box-shadow:
        0 22px 45px rgba(0, 0, 0, 0.12),
        0 0 0 1px rgba(0, 0, 0, 0.03);
      padding: 18px 18px 16px;
      position: relative;
      overflow: hidden;
    }

    .admin-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(135deg, rgba(244, 162, 38, 0.08), transparent 55%),
        repeating-linear-gradient(-45deg,
          rgba(249, 207, 124, 0.08),
          rgba(249, 207, 124, 0.08) 6px,
          transparent 6px,
          transparent 12px);
      pointer-events: none;
    }

    .admin-inner {
      position: relative;
      z-index: 1;
    }

    /* HEADER */

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    /* ===== M√ÄU M√ÄU N√ÇU NH·∫†T (WHEAT/TAN) CHO B·∫¢NG S·ª∞ C·ªê / QU√Å H·∫†N ===== */
    .dark-wood-panel {
      display: none;
      /* M·∫∑c ƒë·ªãnh ·∫©n */
      margin-top: 15px;
      padding: 15px;
      border-radius: 16px;
      /* Background m√†u n√¢u nh·∫°t ·∫•m √°p (Wheat/Tan) */
      background: linear-gradient(145deg, #f5deb3, #daa520);
      color: #3e2723;
      /* Ch·ªØ n√¢u ƒë·∫≠m ƒë·ªÉ d·ªÖ ƒë·ªçc */
      border: 1px solid #c19a6b;
      box-shadow: 0 6px 16px rgba(139, 90, 43, 0.25);
      position: relative;
    }

    .dark-wood-panel h4 {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 700;
      /* ƒê·∫≠m r√µ */
      color: #6d4c41;
      /* N√¢u chocolate ƒë·∫≠m */
      border-bottom: 2px solid rgba(62, 39, 35, 0.2);
      padding-bottom: 8px;
    }

    .dark-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      /* TƒÉng size */
    }

    .dark-table th {
      text-align: left;
      padding: 7px;
      color: #4e342e;
      /* N√¢u ƒë·∫≠m */
      font-weight: 700;
      /* ƒê·∫≠m r√µ */
      border-bottom: 2px solid rgba(62, 39, 35, 0.3);
    }

    .dark-table td {
      padding: 7px;
      border-bottom: 1px solid rgba(62, 39, 35, 0.15);
      color: #5d4037;
      /* N√¢u v·ª´a */
      font-weight: 600;
      /* Ch·ªØ ƒë·∫≠m h∆°n t√≠ */
    }

    .dark-table .small-text {
      color: #6d4c41;
      font-size: 11px;
      font-weight: 600;
    }

    .dark-table button {
      margin-right: 4px;
    }

    .brand-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-icon {
      width: 50px;
      height: 50px;
      border-radius: 16px;
      background: linear-gradient(145deg, var(--wood-accent), var(--wood-accent-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 24px;
      box-shadow: 0 6px 14px rgba(201, 122, 18, 0.5);
    }

    .brand-text h1 {
      margin: 0;
      font-size: 21px;
      font-weight: 600;
    }

    .brand-text p {
      margin: 2px 0 0;
      font-size: 12px;
      opacity: 0.8;
    }

    .user-info {
      text-align: right;
      font-size: 12px;
    }

    .user-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(255, 237, 213, 0.9);
      border: 1px solid rgba(148, 121, 72, 0.35);
      color: var(--wood-text);
    }

    #userRoleBadge {
      margin-left: 4px;
      border-radius: 999px;
      padding: 1px 7px;
      border: 1px solid #fbbf24;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #92400e;
      background: rgba(252, 211, 77, 0.4);
    }

    .btn-logout {
      background: linear-gradient(135deg, #f97316, #b45309);
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 8px rgba(180, 83, 9, 0.4);
    }

    /* Tabs */

    .admin-tabs {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(255, 237, 213, 0.9);
      padding: 4px;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .admin-tab {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      color: rgba(76, 57, 34, 0.8);
    }

    .admin-tab.active {
      background: linear-gradient(135deg, var(--wood-accent), var(--wood-accent-dark));
      color: #fff;
      box-shadow: 0 4px 10px rgba(201, 122, 18, 0.45);
    }

    .admin-body {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.7fr);
      gap: 14px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .admin-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      border-radius: 18px;
      padding: 12px 12px 10px;
      background: rgba(255, 250, 235, 0.95);
      border: 1px solid rgba(212, 163, 72, 0.4);
      font-size: 13px;
    }

    .panel h3 {
      margin: 0 0 6px;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel p {
      margin: 0 0 8px;
      font-size: 12px;
      opacity: 0.8;
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 13px;
    }

    select,
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid rgba(148, 121, 72, 0.4);
      outline: none;
      font-size: 13px;
      margin-top: 2px;
      background: rgba(255, 255, 255, 0.9);
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    select:focus,
    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: var(--wood-accent);
      box-shadow: 0 0 0 1px rgba(244, 162, 38, 0.25),
        0 0 0 4px rgba(244, 162, 38, 0.1);
      background: #fffbeb;
    }

    .btn-primary {
      margin-top: 8px;
      padding: 7px 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #22c55e, #15803d);
      color: #fff;
      box-shadow: 0 4px 10px rgba(21, 128, 61, 0.5);
    }

    .btn-danger {
      margin-top: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color: #fff;
      box-shadow: 0 3px 8px rgba(185, 28, 28, 0.5);
    }

    .btn-secondary {
      margin-top: 4px;
      padding: 5px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 121, 72, 0.5);
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fffbeb;
      color: var(--wood-text);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
    }

    .badge-status {
      background: rgba(148, 163, 184, 0.2);
      color: #374151;
    }

    .badge-status.booked {
      background: rgba(59, 130, 246, 0.15);
      color: #1d4ed8;
    }

    .badge-status.loaded {
      background: rgba(234, 179, 8, 0.15);
      color: #92400e;
    }

    .badge-status.opened {
      background: rgba(34, 197, 94, 0.15);
      color: #166534;
    }

    .badge-status.in-use {
      background: rgba(139, 92, 246, 0.15);
      color: #6d28d9;
    }

    .badge-status.expired {
      background: rgba(239, 68, 68, 0.15);
      color: #b91c1c;
    }

    .badge-status.needs-admin {
      background: rgba(239, 68, 68, 0.4);
      color: #7f1d1d;
      font-weight: 700;
      border: 1px solid #7f1d1d;
    }

    .status-dot-small {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    #reservationsTable {
      table-layout: auto;
    }

    #reservationsTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;
    }

    #reservationsTable th,
    #reservationsTable td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(148, 121, 72, 0.4);
      text-align: left;
      vertical-align: top;
    }

    #reservationsTable th {
      font-weight: 600;
      font-size: 11px;
    }

    /* ===== FIX: logs table kh√¥ng tr√†n / kh√¥ng l·ªách ===== */
    #panelLogs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    #logsTable {
      width: 100%;
      min-width: 820px;
      /* m√†n h·∫πp s·∫Ω c√≥ scroll ngang */
      table-layout: fixed;
      /* c·ªë ƒë·ªãnh c·ªôt */
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;
    }

    #logsTable th,
    #logsTable td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(148, 121, 72, 0.4);
      text-align: left;
      vertical-align: top;

      white-space: normal;
      /* cho xu·ªëng d√≤ng */
      word-break: break-word;
      /* b·∫ª ch·ªØ d√†i */
      overflow-wrap: anywhere;
    }

    /* set width c·ªôt cho g·ªçn */
    #logsTable th:nth-child(1),
    #logsTable td:nth-child(1) {
      width: 120px;
    }

    /* th·ªùi gian */
    #logsTable th:nth-child(2),
    #logsTable td:nth-child(2) {
      width: 110px;
    }

    /* sƒët */
    #logsTable th:nth-child(3),
    #logsTable td:nth-child(3) {
      width: 60px;
    }

    /* t·ªß */
    #logsTable th:nth-child(5),
    #logsTable td:nth-child(5) {
      width: 70px;
    }

    /* k·∫øt qu·∫£ */
    #logsTable th:nth-child(6),
    #logsTable td:nth-child(6) {
      width: 220px;
    }

    /* ƒë∆°n */

    /* c·ªôt h√†nh ƒë·ªông cho ph√©p d√†i nh∆∞ng v·∫´n xu·ªëng d√≤ng */
    #logsTable th:nth-child(4),
    #logsTable td:nth-child(4) {
      width: 220px;
    }


    /* ===== Fix layout cho overdueWrap + incidentsWrap ===== */
    #overdueWrap,
    #incidentsWrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ƒê·∫£m b·∫£o b·∫£ng b√™n trong kh√¥ng b·ªã co l·∫°i qu√° m·ª©c tr√™n mobile */
    .dark-table {
      min-width: 760px;
      table-layout: fixed;
    }

    /* Style chung cho text trong b·∫£ng (xu·ªëng d√≤ng khi qu√° d√†i) */
    .dark-table th,
    .dark-table td {
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
    }


    /* Incidents table: gi·ªëng style overdue */
    #incidentsTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 11px;
    }

    #incidentsTable th,
    #incidentsTable td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(148, 121, 72, 0.4);
      text-align: left;
      vertical-align: top;
    }

    #incidentsTable th {
      font-weight: 600;
      font-size: 11px;
    }


    /* Disabled button nh√¨n r√µ l√† disable ch·ª© kh√¥ng ‚Äúm·∫•t‚Äù */
    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none !important;
      filter: grayscale(0.25);
    }

    #tabLockers {
      display: none;
    }

    #panelLockers {
      display: none !important;
    }

    /* ===== FIX layout: b·∫°n ƒë√£ t·∫Øt panel lockers n√™n d√πng 1 c·ªôt cho admin-body ===== */
    .admin-body {
      grid-template-columns: minmax(0, 1fr) !important;
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div class="admin-card">
      <div class="admin-inner">
        <!-- HEADER -->
        <header class="admin-header">
          <div class="brand-left">
            <div class="brand-icon">
              <i class="fas fa-user-shield"></i>
            </div>
            <div class="brand-text">
              <h1>Smart Locker - Admin</h1>
              <p>Qu·∫£n l√Ω t·ªß, ƒë∆°n ƒë·∫∑t t·ªß & nh·∫≠t k√Ω h·ªá th·ªëng</p>
            </div>
          </div>

          <div class="user-info">
            <div class="user-pill">
              <i class="fas fa-user"></i>
              <span id="userPhone">--</span>
              <span id="userRoleBadge">ADMIN</span>
            </div>
            <div>
              <button class="btn-logout" onclick="authManager.logout()">
                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
              </button>
            </div>
          </div>
        </header>

        <!-- TABS -->
        <div class="admin-tabs">
          <button id="tabLockers" class="admin-tab active">
            <i class="fas fa-door-open"></i> T·ªß & ƒëi·ªÅu khi·ªÉn
          </button>
          <button id="tabReservations" class="admin-tab">
            <i class="fas fa-box"></i> T·∫•t c·∫£ ƒë∆°n ƒë·∫∑t t·ªß
          </button>
          <button id="tabLogs" class="admin-tab">
            <i class="fas fa-list"></i> Nh·∫≠t k√Ω h·ªá th·ªëng
          </button>
        </div>

        <!-- BODY -->
        <div class="admin-body">
          <!-- C·ªòT TR√ÅI: T·ª¶ & ƒêI·ªÄU KHI·ªÇN -->
          <section id="panelLockers" class="panel">
            <h3><i class="fas fa-door-open"></i> T√¨nh tr·∫°ng t·ªß & ƒëi·ªÅu khi·ªÉn</h3>
            <p>
              Admin c√≥ th·ªÉ m·ªü/ƒë√≥ng t·ªß t·ª´ xa (v√≠ d·ª• khi t·ªß b·ªã k·∫πt, c∆∞·ª°ng ch·∫ø m·ªü khi ƒë∆°n ƒë√£ qu√° h·∫°n...).
            </p>

            <div style="margin-top:6px;">
              <div class="small-text">
                <strong>Locker 1</strong> ‚Äì tr·∫°ng th√°i hi·ªán t·∫°i:
                <span id="lockerStatusText" class="badge badge-status">
                  <span class="status-dot-small"></span> ƒêang t·∫£i...
                </span>
              </div>
              <div class="small-text">
                C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="lockerLastUpdate">--</span>
              </div>
            </div>

            <button id="btnOpenLocker" class="btn-primary" onclick="controlLocker('open')">
              <i class="fas fa-unlock"></i> M·ªü t·ªß Locker 1
            </button>
            <button id="btnCloseLocker" class="btn-secondary" onclick="controlLocker('close')">
              <i class="fas fa-lock"></i> ƒê√≥ng t·ªß Locker 1
            </button>

            <div class="small-text" style="margin-top:8px;">
              <i class="fas fa-triangle-exclamation"></i>
              Khi c∆∞·ª°ng ch·∫ø m·ªü t·ªß v√¨ ƒë∆°n qu√° h·∫°n, h√£y c·∫≠p nh·∫≠t bi√™n b·∫£n b√™n ngo√†i (n·∫øu c√≥).
            </div>
          </section>

          <!-- C·ªòT PH·∫¢I: PANEL ƒê·ªòNG (ƒê∆†N + LOGS) -->
          <section id="panelReservations" class="panel" style="display: block;">
            <h3><i class="fas fa-box"></i> T·∫•t c·∫£ ƒë∆°n ƒë·∫∑t t·ªß</h3>
            <p>
              Danh s√°ch t·∫•t c·∫£ ƒë∆°n ƒë·∫∑t t·ªß trong h·ªá th·ªëng. Admin c√≥ th·ªÉ xem tr·∫°ng th√°i, ph√°t hi·ªán ƒë∆°n qu√° h·∫°n
              v√† c∆∞·ª°ng ch·∫ø m·ªü t·ªß n·∫øu c·∫ßn (h·ªó tr·ª£ x·ª≠ l√Ω t√¨nh hu·ªëng kh·∫©n c·∫•p).
            </p>

            <button class="btn-secondary" onclick="loadAdminReservations()">
              <i class="fas fa-rotate-right"></i> T·∫£i l·∫°i danh s√°ch ƒë∆°n
            </button>
            <button class="btn-secondary" id="btnToggleOverdue" onclick="toggleOverdueTable()">
              <i class="fas fa-triangle-exclamation"></i> ƒê∆°n qu√° h·∫°n
            </button>
            <button class="btn-secondary" id="btnToggleIncidents" onclick="toggleIncidentsTable()">
              <i class="fas fa-bug"></i> S·ª± c·ªë
            </button>

            <!-- ‚úÖ KHU V·ª∞C ƒê∆†N QU√Å H·∫†N (DARK WOOD) -->
            <div id="overdueWrap" class="dark-wood-panel">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
                <h4><i class="fas fa-triangle-exclamation"></i> Danh s√°ch ƒë∆°n qu√° h·∫°n</h4>
                <button class="btn-secondary" onclick="loadOverdueTable()" style="font-size:10px; padding:2px 8px;">
                  <i class="fas fa-rotate-right"></i> T·∫£i l·∫°i
                </button>
              </div>

              <div class="small-text" id="overdueSummary" style="margin-top:4px; color:#3e2723; font-weight:700;"></div>

              <div id="overdueEmpty"
                style="margin-top:6px; font-size:12px; color:#4e342e; font-weight:700; display:none;">
                Kh√¥ng c√≥ ƒë∆°n qu√° h·∫°n c·∫ßn x·ª≠ l√Ω.
              </div>

              <table id="overdueTable" class="dark-table" style="display:none;">
                <thead>
                  <tr>
                    <th>M√£ ƒë∆°n (Reser)</th>
                    <th>T·ªß</th>
                    <th>C·ª≠a</th>
                    <th>C·∫£m bi·∫øn</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>SƒêT Nh·∫≠n</th>
                    <th>H·∫øt h·∫°n</th>
                    <th>Thao t√°c</th>
                  </tr>
                </thead>
                <tbody id="overdueTbody"></tbody>
              </table>
            </div>

            <!-- ‚úÖ KHU V·ª∞C S·ª∞ C·ªê (DARK WOOD) - T√ÅCH RI√äNG -->
            <div id="incidentsWrap" class="dark-wood-panel">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
                <h4><i class="fas fa-bug"></i> Danh s√°ch s·ª± c·ªë (Incidents)</h4>
                <button class="btn-secondary" onclick="loadIncidentsTable()" style="font-size:10px; padding:2px 8px;">
                  <i class="fas fa-rotate-right"></i> T·∫£i l·∫°i
                </button>
              </div>

              <div class="small-text" id="incidentsSummary" style="margin-top:4px; color:#3e2723; font-weight:700;">
              </div>

              <div id="incidentsEmpty"
                style="margin-top:6px; font-size:12px; color:#4e342e; font-weight:700; display:none;">
                Kh√¥ng c√≥ s·ª± c·ªë ƒëang m·ªü.
              </div>

              <table id="incidentsTable" class="dark-table" style="display:none;">
                <thead>
                  <tr>
                    <th>Th·ªùi gian</th>
                    <th>Lo·∫°i l·ªói</th>
                    <th>T·ªß</th>
                    <th>M√£ ƒë∆°n </th>
                    <th>Ghi ch√∫ </th>
                    <th>Tr·∫°ng th√°i l·ªói</th>
                    <th>Thao t√°c</th>
                  </tr>
                </thead>
                <tbody id="incidentsTbody"></tbody>
              </table>
            </div>


            <div class="small-text" style="margin-top:4px;" id="reservationsSummary"></div>

            <div id="reservationsEmpty" style="margin-top:6px; font-size:12px; color:#9ca3af; display:none;">
              Hi·ªán ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t t·ªß n√†o.
            </div>

            <table id="reservationsTable" style="display:none;">
              <thead>
                <tr>
                  <th>Th·ªùi gian t·∫°o</th>
                  <th>Ng∆∞·ªùi nh·∫≠n</th>
                  <th>T·ªß</th>
                  <th>M√£ ƒë·∫∑t t·ªß</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>H·∫øt h·∫°n</th>

                </tr>
              </thead>
              <tbody id="reservationsTbody"></tbody>
            </table>
          </section>

          <section id="panelLogs" class="panel" style="display:none;">
            <h3><i class="fas fa-list"></i> Nh·∫≠t k√Ω h·ªá th·ªëng</h3>
            <p>
              Ghi l·∫°i c√°c thao t√°c m·ªü/ƒë√≥ng t·ªß, nh·∫≠n h√†ng, c∆∞·ª°ng ch·∫ø... ph·ª•c v·ª• ki·ªÉm tra khi c·∫ßn.
            </p>

            <button class="btn-secondary" onclick="loadAdminLogs()">
              <i class="fas fa-rotate-right"></i> T·∫£i l·∫°i nh·∫≠t k√Ω
            </button>

            <div id="logsEmpty" style="margin-top:6px; font-size:12px; color:#9ca3af; display:none;">
              Ch∆∞a c√≥ log n√†o.
            </div>

            <table id="logsTable" style="display:none;">
              <thead>
                <tr>
                  <th>Th·ªùi gian</th>
                  <th>SƒêT</th>
                  <th>T·ªß</th>
                  <th>H√†nh ƒë·ªông</th>
                  <th>K·∫øt qu·∫£</th>
                  <th>ƒê∆°n</th>
                </tr>
              </thead>
              <tbody id="logsTbody"></tbody>
            </table>
          </section>
        </div>

      </div>
    </div>
  </div>

  <!-- Auth -->
  <script src="auth.js"></script>

  <script>
    const API_BASE = "/api";

    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p & role admin
    (function initAuth() {
      if (!authManager.requireAuth()) return;

      const role = localStorage.getItem("role") || "resident";
      if (role !== "admin") {
        alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin. S·∫Ω quay v·ªÅ dashboard.");
        window.location.href = "/dashboard.html";
        return;
      }

      const phoneSpan = document.getElementById("userPhone");
      if (phoneSpan) {
        phoneSpan.textContent = authManager.formatPhoneNumber(authManager.phoneNumber);
      }
    })();

    // Tabs
    const tabLockers = document.getElementById("tabLockers");
    const tabReservations = document.getElementById("tabReservations");
    const tabLogs = document.getElementById("tabLogs");
    const panelLockers = document.getElementById("panelLockers");
    const panelReservations = document.getElementById("panelReservations");
    const panelLogs = document.getElementById("panelLogs");

    function setActiveTab(name) {
      tabLockers.classList.remove("active");
      tabReservations.classList.remove("active");
      tabLogs.classList.remove("active");
      panelLockers.style.display = "none";
      panelReservations.style.display = "none";
      panelLogs.style.display = "none";

      if (name === "lockers") {
        tabLockers.classList.add("active");
        panelLockers.style.display = "block";
      } else if (name === "reservations") {
        tabReservations.classList.add("active");
        panelReservations.style.display = "block";
      } else {
        tabLogs.classList.add("active");
        panelLogs.style.display = "block";
      }
    }

    tabLockers.addEventListener("click", () => setActiveTab("lockers"));
    tabReservations.addEventListener("click", () => {
      setActiveTab("reservations");
      loadAdminReservations();
      //startAutoRefresh();
    });
    tabLogs.addEventListener("click", () => {
      setActiveTab("logs");
      loadAdminLogs();
      stopAutoRefresh();
    });



    // === Admin: xem t·∫•t c·∫£ ƒë∆°n, c∆∞·ª°ng ch·∫ø m·ªü khi qu√° h·∫°n ===
    async function loadAdminReservations() {
      const tbody = document.getElementById("reservationsTbody");
      const table = document.getElementById("reservationsTable");
      const emptyEl = document.getElementById("reservationsEmpty");
      const summaryEl = document.getElementById("reservationsSummary");

      if (!tbody) return;
      tbody.innerHTML = "";
      if (emptyEl) emptyEl.style.display = "none"
      if (table) table.style.display = "none";
      if (summaryEl) summaryEl.textContent = "ƒêang t·∫£i danh s√°ch ƒë∆°n...";

      try {
        const res = await fetch(`${API_BASE}/admin/reservations-all`, {
          method: "GET",
          headers: authManager.getAuthHeaders()
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          throw new Error(data.error || "Kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch ƒë∆°n");
        }

        const reservations = data.reservations || [];
        if (!reservations.length) {
          if (emptyEl) emptyEl.style.display = "block";
          if (summaryEl) summaryEl.textContent = "0 ƒë∆°n trong h·ªá th·ªëng.";
          return;
        }

        if (table) table.style.display = "table";

        const now = Date.now();
        let expiredCount = 0;
        let total = reservations.length;

        reservations.forEach(r => {
          const tr = document.createElement("tr");
          const createdAt = r.createdAt
            ? new Date(r.createdAt).toLocaleString("vi-VN")
            : "-";
          const expiresAt = r.expiresAt
            ? new Date(r.expiresAt).toLocaleString("vi-VN")
            : "-";
          const isDone = (String(r.status || "").toLowerCase() === "done");
          const isExpired = !isDone && r.expiresAt && now > r.expiresAt;

          if (isExpired) expiredCount++;

          let statusClass = "badge-status";
          if (r.status === "booked") statusClass += " booked";
          else if (r.status === "loaded") statusClass += " loaded";
          else if (r.status === "opened") statusClass += " opened";
          else if (r.status === "in_use") statusClass += " in-use";

          const needsFix = (r.needAdminPickup === true);
          if (needsFix) statusClass += " needs-admin";
          if (isExpired) statusClass += " expired";

          const statusHtml = `
            <span class="badge ${statusClass}">
              <span class="status-dot-small" style="background:${(isExpired || needsFix) ? "#ef4444" : "#22c55e"};"></span>
              ${r.status || "unknown"}${isExpired ? " (qu√° h·∫°n)" : ""}${needsFix ? " (L·ªñI)" : ""}
            </span>
          `;



          tr.innerHTML = `
            <td>${createdAt}</td>
            <td class="small-text">${r.receiverPhone || "-"}</td>
            <td>${r.lockerId || "-"}</td>
            <td>${r.bookingCode || "-"}</td>
            <td>${statusHtml}</td>
            <td>${expiresAt}</td>
          
          `;
          tbody.appendChild(tr);
        });

        if (summaryEl) {
          summaryEl.textContent = `T·ªïng: ${total} ƒë∆°n. ƒê∆°n ƒëang qu√° h·∫°n: ${expiredCount}.`;
        }
      } catch (err) {
        console.error(err);
        if (summaryEl) summaryEl.textContent = err.message || "L·ªói t·∫£i danh s√°ch ƒë∆°n.";
        alert(err.message || "Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n.");
      }
    }

    // === Admin: load logs ===
    async function loadAdminLogs() {
      const tbody = document.getElementById("logsTbody");
      const table = document.getElementById("logsTable");
      const emptyEl = document.getElementById("logsEmpty");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (emptyEl) emptyEl.style.display = "none";
      if (table) table.style.display = "none";

      try {
        const res = await fetch(`${API_BASE}/admin/logs`, {
          method: "GET",
          headers: authManager.getAuthHeaders()
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          throw new Error(data.error || "Kh√¥ng l·∫•y ƒë∆∞·ª£c nh·∫≠t k√Ω");
        }

        const logs = data.logs || [];
        if (!logs.length) {
          if (emptyEl) emptyEl.style.display = "block";
          return;
        }

        if (table) table.style.display = "table";

        logs.forEach(l => {
          const tr = document.createElement("tr");
          const ts = l.timestamp
            ? new Date(l.timestamp).toLocaleString("vi-VN")
            : "-";

          tr.innerHTML = `
            <td>${ts}</td>
            <td class="small-text">${l.phone || "-"}</td>
            <td>${l.locker || "-"}</td>
            <td>${l.action || "-"}</td>
            <td>${l.result || "-"}</td>
            <td class="small-text">${l.reservationId || "-"}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert(err.message || "Kh√¥ng th·ªÉ t·∫£i nh·∫≠t k√Ω.");
      }
    }
    // ====== TOGGLE OVERDUE TABLE ======
    let overdueVisible = false;

    function toggleOverdueTable() {
      const wrap = document.getElementById("overdueWrap");
      const btn = document.getElementById("btnToggleOverdue");
      overdueVisible = !overdueVisible;

      if (wrap) wrap.style.display = overdueVisible ? "block" : "none";
      if (btn) {
        btn.innerHTML = overdueVisible
          ? '<i class="fas fa-times"></i> ƒê√≥ng Overdue'
          : '<i class="fas fa-triangle-exclamation"></i> <strong>ƒê∆°n qu√° h·∫°n</strong>';
        btn.style.background = overdueVisible ? "#8b5a2b" : "#fff7ed";
        btn.style.color = overdueVisible ? "#fff" : "#78350f";
      }

      // v·ª´a b·∫≠t l√™n th√¨ load lu√¥n
      if (overdueVisible) loadOverdueTable();
    }

    function normalizeDoorState(s) {
      return String(s || "").trim().toLowerCase();
    }
    function isDoorOpenState(doorState) {
      const ds = normalizeDoorState(doorState);
      return ds === "open" || ds === "opened" || ds === "opening";
    }
    function isDoorClosedState(doorState) {
      const ds = normalizeDoorState(doorState);
      return ds === "close" || ds === "closed" || ds === "closing";
    }

    // ====== LOAD OVERDUE TABLE ======
    async function loadOverdueTable() {
      const tbody = document.getElementById("overdueTbody");
      const table = document.getElementById("overdueTable");
      const emptyEl = document.getElementById("overdueEmpty");
      const summaryEl = document.getElementById("overdueSummary");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (emptyEl) emptyEl.style.display = "none";
      if (table) table.style.display = "none";
      if (summaryEl) summaryEl.textContent = "ƒêang t·∫£i...";

      try {
        const res = await fetch(`${API_BASE}/admin/overdue-table`, {
          method: "GET",
          headers: authManager.getAuthHeaders()
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          throw new Error(data.error || "Kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch ƒë∆°n qu√° h·∫°n");
        }

        const rows = data.rows || [];
        if (!rows.length) {
          if (emptyEl) emptyEl.style.display = "block";
          if (summaryEl) summaryEl.textContent = "0 ƒë∆°n qu√° h·∫°n c·∫ßn x·ª≠ l√Ω.";
          return;
        }

        if (table) table.style.display = "table";
        if (summaryEl) summaryEl.textContent = `C√≥ ${rows.length} ƒë∆°n qu√° h·∫°n (l√¢u nh·∫•t l√™n ƒë·∫ßu).`;

        rows.forEach(r => {
          const tr = document.createElement("tr");
          const exp = r.expiresAt ? new Date(r.expiresAt).toLocaleString("vi-VN") : "-";
          const hasItemText = (r.hasItem === true) ? "true" : (r.hasItem === false ? "false" : "-");

          const disableOpen = !!r.doorState && isDoorOpenState(r.doorState);
          const disableClose = !!r.doorState && isDoorClosedState(r.doorState);
          const disableConfirm = (r.hasItem === true); // n·∫øu c√≥ c·∫£m bi·∫øn th√¨ ch·∫∑n nh·∫£ t·ªß khi c√≤n h√†ng

          tr.innerHTML = `
        <td class="small-text">${r.reservationId || "-"}</td>
        <td>${r.lockerId || "-"}</td>
        <td>${r.doorState || "-"}</td>
        <td>${hasItemText}</td>
        <td>${r.status || "-"}</td>
        <td class="small-text">${r.receiverPhone || "-"}</td>
        <td>${exp}</td>
        <td>
          <button class="btn-primary" style="margin-top:0;" ${disableOpen ? "disabled" : ""} onclick="adminOverdueOpen('${r.reservationId}')">
            <i class="fas fa-unlock"></i> M·ªü
          </button>
          <button class="btn-secondary" style="margin-top:0;" ${disableClose ? "disabled" : ""} onclick="adminOverdueClose('${r.reservationId}')">
            <i class="fas fa-lock"></i> ƒê√≥ng
          </button>
          <button class="btn-danger" style="margin-top:0;" ${disableConfirm ? "disabled" : ""} onclick="adminOverdueConfirmPicked('${r.reservationId}', ${r.hasItem === true ? "true" : "false"})">
            <i class="fas fa-check"></i> X√°c nh·∫≠n l·∫•y
          </button>
          ${r.hasItem === true ? `<div class="small-text" style="color:#b91c1c;margin-top:4px;">hasItem=true ‚Üí ch∆∞a cho x√°c nh·∫≠n nh·∫£ t·ªß.</div>` : ``}
        </td>
      `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error(err);
        if (summaryEl) summaryEl.textContent = err.message || "L·ªói t·∫£i danh s√°ch ƒë∆°n qu√° h·∫°n.";
      }
    }

    // ====== ACTIONS ======
    async function adminOverdueOpen(reservationId) {
      const ok = confirm("M·ªü t·ªß ƒë·ªÉ thu h·ªìi?\nH√£y ch·∫Øc ch·∫Øn b·∫°n ƒëang ƒë·ª©ng t·∫°i t·ªß.");
      if (!ok) return;

      const res = await fetch(`${API_BASE}/admin/overdue/open`, {
        method: "POST",
        headers: { ...authManager.getAuthHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({ reservationId })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.success === false) return alert(data.error || "M·ªü t·ªß th·∫•t b·∫°i");

      alert("ƒê√£ g·ª≠i l·ªánh m·ªü.");
      loadOverdueTable();
    }

    async function adminOverdueClose(reservationId) {
      const res = await fetch(`${API_BASE}/admin/overdue/close`, {
        method: "POST",
        headers: { ...authManager.getAuthHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({ reservationId })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.success === false) return alert(data.error || "ƒê√≥ng t·ªß th·∫•t b·∫°i");

      alert("ƒê√£ g·ª≠i l·ªánh ƒë√≥ng.");
      loadOverdueTable();
    }

    async function adminOverdueConfirmPicked(reservationId, hasItem) {
      if (hasItem === true) {
        alert("hasItem=true ‚Üí ch∆∞a th·ªÉ x√°c nh·∫≠n nh·∫£ t·ªß. H√£y l·∫•y h·∫øt h√†ng tr∆∞·ªõc.");
        return;
      }

      const ok = confirm("X√°c nh·∫≠n admin ƒë√£ l·∫•y h√†ng v√† nh·∫£ t·ªß?");
      if (!ok) return;

      const res = await fetch(`${API_BASE}/admin/overdue/confirm-picked`, {
        method: "POST",
        headers: { ...authManager.getAuthHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({ reservationId })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.success === false) return alert(data.error || "X√°c nh·∫≠n th·∫•t b·∫°i");

      alert("ƒê√£ x√°c nh·∫≠n l·∫•y h√†ng & nh·∫£ t·ªß.");
      loadOverdueTable();
      loadAdminReservations();
    }
    let autoTimer = null;

    function startAutoRefresh() {
      stopAutoRefresh();
      autoTimer = setInterval(() => {
        // ch·ªâ refresh c√°i ƒëang hi·ªÉn th·ªã
        if (panelReservations.style.display !== "none") {
          loadAdminReservations();
          if (overdueVisible) loadOverdueTable();
        }
        if (panelLockers.style.display !== "none") {
          // refreshLockerStatus();
        }
      }, 10000); // 5 gi√¢y, b·∫°n ch·ªânh 3-10s tu·ª≥ th√≠ch
    }

    function stopAutoRefresh() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = null;
    }

    //incident
    // ====== TOGGLE INCIDENTS ======
    let incidentsVisible = false;

    function toggleIncidentsTable() {
      const wrap = document.getElementById("incidentsWrap");
      const btn = document.getElementById("btnToggleIncidents");
      incidentsVisible = !incidentsVisible;

      if (wrap) wrap.style.display = incidentsVisible ? "block" : "none";
      if (btn) {
        btn.innerHTML = incidentsVisible
          ? '<i class="fas fa-times"></i> ƒê√≥ng Incidents'
          : '<i class="fas fa-bug"></i> <strong>S·ª± c·ªë (Incidents)</strong>';
        btn.style.background = incidentsVisible ? "#8b5a2b" : "#fef2f2";
        btn.style.color = incidentsVisible ? "#fff" : "#7f1d1d";
      }

      if (incidentsVisible) loadIncidentsTable();
    }

    function fmtTime(ms) {
      if (!ms) return "-";
      return new Date(ms).toLocaleString("vi-VN");
    }

    // ====== LOAD INCIDENTS ======
    async function loadIncidentsTable() {
      const tbody = document.getElementById("incidentsTbody");
      const table = document.getElementById("incidentsTable");
      const emptyEl = document.getElementById("incidentsEmpty");
      const summaryEl = document.getElementById("incidentsSummary");
      if (!tbody) return;

      tbody.innerHTML = "";
      if (emptyEl) emptyEl.style.display = "none";
      if (table) table.style.display = "none";
      if (summaryEl) summaryEl.textContent = "ƒêang t·∫£i incidents...";

      try {
        const res = await fetch(`${API_BASE}/admin/incidents?status=open&limit=200`, {
          method: "GET",
          headers: authManager.getAuthHeaders(),
          // n·∫øu b·∫°n d√πng cookie authToken thay v√¨ header, b·∫≠t th√™m d√≤ng d∆∞·ªõi:
          // credentials: "include"
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          throw new Error(data.error || "Kh√¥ng l·∫•y ƒë∆∞·ª£c incidents");
        }

        const rows = data.rows || [];
        if (!rows.length) {
          if (emptyEl) emptyEl.style.display = "block";
          if (summaryEl) summaryEl.textContent = "0 s·ª± c·ªë ƒëang m·ªü.";
          return;
        }

        if (table) table.style.display = "table";
        if (summaryEl) summaryEl.textContent = `ƒêang m·ªü: ${rows.length} s·ª± c·ªë.`;

        rows.forEach(it => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${fmtTime(it.createdAt)}</td>
        <td>${it.type || "-"}</td>
        <td>${it.lockerId || "-"}</td>
        <td class="small-text">${it.reservationId || "-"}</td>
        <td class="small-text">${(it.note || "").toString()}</td>
        <td>${it.status || "-"}</td>
        <td>
          <button class="btn-danger" style="margin-top:0;" onclick="resolveIncident('${it.id}')">
            <i class="fas fa-check"></i> Resolve
          </button>
        </td>
      `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error(err);
        if (summaryEl) summaryEl.textContent = err.message || "L·ªói load incidents.";
      }
    }

    // ====== RESOLVE INCIDENT ======
    async function resolveIncident(incidentId) {
      const ok = confirm("ƒê√≥ng s·ª± c·ªë n√†y (resolve)?");
      if (!ok) return;

      const res = await fetch(`${API_BASE}/admin/incidents/resolve`, {
        method: "POST",
        headers: { ...authManager.getAuthHeaders(), "Content-Type": "application/json" },
        // n·∫øu d√πng cookie:
        // credentials: "include",
        body: JSON.stringify({ incidentId })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.success === false) {
        return alert(data.error || "Resolve th·∫•t b·∫°i");
      }

      alert("ƒê√£ resolve s·ª± c·ªë.");
      loadIncidentsTable();
    }




    // Kh·ªüi t·∫°o ban ƒë·∫ßu
    document.addEventListener("DOMContentLoaded", () => {
      loadAdminReservations();
      // startAutoRefresh();
    });
  </script>
</body>

</html>